( function () {
	/* global sas */
	/* global wa_smart */
	/* global PWT */
	/* global owpbjs */
	/* global console */

	let wordads = window.wordads || {
		tcData: undefined,
		usPrivacy: undefined,
		logging:
			typeof URLSearchParams === 'function'
				? new URLSearchParams( window.location.search ).get( 'wordads-logging' ) === 'true'
				: false,
		slots: [],
	};

	wordads.log = function ( msg ) {
		if ( wordads.logging ) {
			console.log( msg );
		}
	};

	wordads.trackStat = function ( stat ) {
		window._stq = window._stq || [];
		window._stq.push( [
			'extra',
			{
				x_wordads_smart: stat,
			},
		] );
	};

	wordads.recordTracksEvent = function ( eventName, eventProps ) {
		eventProps = eventProps || {};
		window._tkq = window._tkq || [];
		window._tkq.push( [ 'recordEvent', eventName, eventProps ] );
	};

	wordads.createInlineAdSnippet = function ( tagId ) {
		let wrapper = document.createElement( 'div' );
		let ad = document.createElement( 'div' );
		let title = document.createElement( 'div' );
		let content = document.createElement( 'div' );
		let controls = document.createElement( 'div' );

		wrapper.classList.add( 'wordads-ad-wrapper' );
		ad.classList.add( 'wordads-ad' );
		title.classList.add( 'wordads-ad-title' );
		content.classList.add( 'wordads-ad-content' );
		content.classList.add( 'wordads-ad-inline' );
		controls.classList.add( 'wordads-ad-controls' );

		title.innerText = wa_smart.inline.title;
		content.id = tagId;
		controls.innerHTML = wa_smart.inline.gdpr;

		ad.appendChild( title );
		ad.appendChild( content );
		ad.appendChild( controls );

		wrapper.appendChild( ad );

		return wrapper;
	};

	wordads.insertInlineAdBefore = function ( element ) {
		let tagId = 'wordads-ad-' + Math.trunc( Math.random() * 1000000 );
		let snippet = wordads.createInlineAdSnippet( tagId );
		element.insertAdjacentElement( 'beforebegin', snippet );

		wordads.slots.push( { tagId: tagId, element: snippet, isLazy: true, isLoaded: false } );
		wordads.processAds();
	};

	wordads.call = function ( tagId ) {
		if ( wa_smart.inline.adflow_enabled ) {
			wordads.callAdFlow( tagId );
			return;
		}

		if ( wordads.isOpenWrapReady() ) {
			wordads.callOpenWrap( tagId );
			return;
		}

		wordads.callSmart( tagId );
	};

	wordads.callOpenWrap = function ( tagId ) {
		PWT.requestBids(
			[
				{
					code: tagId,
					divId: tagId,
					adUnitId: tagId,
					adUnitIndex: '',
					mediaTypes: {
						banner: {
							sizes: [ [ 300, 250 ] ],
						},
					},
				},
			],
			function ( resp ) {
				wordads.log( 'OpenWrap response:' );
				wordads.log( resp );

				for ( let i = 0; i < resp.length; i++ ) {
					wordads.log( 'Getting highest bid:' );
					let tagId = resp[ i ].divId;
					let bid = owpbjs.getHighestCpmBids( tagId )[ 0 ];
					wordads.log( bid );

					if ( bid ) {
						sas.setHeaderBiddingWinner( tagId, bid );
					}

					wordads.callSmart( tagId );
				}
			}
		);
	};

	wordads.callSmart = function ( tagId ) {
		sas.cmd.push( function () {
			wordads.log( 'Requesting Smart ad: ' + tagId );
			sas.call( 'std', {
				siteId: wa_smart.site_id,
				pageId: wa_smart.page_id,
				formatId: wa_smart.inline.format_id,
				tagId: tagId,
				content_source_id: wa_smart.blog_id,
				target: wa_smart.target,
			} );
		} );
	};

	wordads.callAdFlow = function ( tagId ) {
		let xhr = new XMLHttpRequest();

		xhr.onreadystatechange = function () {
			if ( XMLHttpRequest.DONE === xhr.readyState ) {
				xhr.endTime = performance.now();

				if ( 200 !== xhr.status ) {
					sas.events.fire( 'noad', { tagId: tagId }, tagId );
					return;
				}

				let response = JSON.parse( xhr.response );
				let ad = response[ tagId ];
				let hasAd = ! ad.hasOwnProperty( 'ScriptNoAd' );

				if ( hasAd ) {
					let script = document.createElement( 'script' );
					script.type = ad.ContentType;
					script.innerHTML = ad.Content;
					document.body.appendChild( script );

					sas.events.fire( 'load', { tagId: tagId }, tagId );
				} else {
					sas.events.fire( 'noad', { tagId: tagId, pixelURL: ad.ScriptNoAd }, tagId );
				}

				wordads.trackAdFlowRequestLatency( xhr, hasAd );
			}
		};

		let body = {
			timestamp: Date.now(),
			networkId: wa_smart.network_id,
			siteId: wa_smart.site_id,
			pageId: wa_smart.page_id,
			content_source_id: wa_smart.blog_id,
			wp_post_id: wa_smart.post_id,
			getAdContent: true,
			ads: [
				{
					formatId: wa_smart.inline.format_id,
					tagId: tagId,
					target: wa_smart.target,
					isLazy: false,
				},
			],
			gdpr: false,
			pageUrl: window.location.href,
			uid: wordads.getOrCreateUserIdentification(),
		};

		if ( wordads.usPrivacy ) {
			body.us_privacy = wordads.usPrivacy;
		}

		if ( wordads.tcData ) {
			body.gdpr = true;
			body.gdpr_consent = wordads.tcData.tcString;
		}

		xhr.open( 'POST', 'https://af.pubmine.com' );
		xhr.setRequestHeader( 'Content-type', 'application/json' );

		xhr.startTime = performance.now();
		xhr.send( JSON.stringify( body ) );
	};

	wordads.trackAdFlowRequestLatency = function ( xhr, hasAd ) {
		let requestTime = Math.round( xhr.endTime - xhr.startTime );

		let eventProps = {
			has_ad: hasAd,
			request_time: requestTime,
			theme: wa_smart.theme,
		};

		if ( navigator.connection ) {
			eventProps.connection_effective_type = navigator.connection.effectiveType;
			eventProps.connection_downlink = navigator.connection.downlink;
		}

		wordads.recordTracksEvent( 'wpcom_wordads_adflow', eventProps );
	};

	wordads.getOrCreateUserIdentification = function () {
		if ( ! window.localStorage ) {
			return '';
		}

		if ( wordads.tcData ) {
			const AUTOMATTIC_ADS_VENDOR_ID = 496;
			const STORE_ACCESS_INFORMATION_ON_DEVICE_PURPOSE_ID = 1;

			if ( ! ( wordads.tcData.vendor.consents[ AUTOMATTIC_ADS_VENDOR_ID ] === true &&
				wordads.tcData.purpose.consents[ STORE_ACCESS_INFORMATION_ON_DEVICE_PURPOSE_ID ] === true ) ) {
				return '';
			}
		}

		const uid_key = 'wordads_smart_uid';
		const expiration_days = 30;

		const item = ( localStorage.getItem( uid_key ) || '' ).split( ':' );
		let uid = item[0];

		const current_time = new Date().getTime();
		let expiration_time = parseInt( item[1] );

		// Create a new uid if not exists or is expired.
		if ( ! uid || current_time > expiration_time ) {
			uid = Math.random().toString( 36 ).substring( 2, 10 ) + current_time.toString();

			const expiration_ms = expiration_days * 24 * 60 * 60 * 1000;
			expiration_time = current_time + expiration_ms;

			localStorage.setItem( uid_key, uid + ':' + expiration_time );
		}

		return uid;
	};

	wordads.insertFallbackAd = function ( target, slotType ) {
		let sas_fallback = window.sas_fallback || [];
		let slot_fallback = sas_fallback.filter( function ( fallback ) {
			return fallback.type === slotType;
		} );

		if ( slot_fallback.length === 0 ) {
			target.remove();
			return;
		}

		// Replace the macro to have a div with a unique id.
		let slot_fallback_tag = slot_fallback[ 0 ].tag.replaceAll(
			'{{unique_id}}',
			Math.trunc( Math.random() * 1000000 )
		);

		// Unescape the tag markup.
		let e = document.createElement( 'div' );
		e.innerHTML = slot_fallback_tag;
		slot_fallback_tag = e.childNodes[ 0 ].nodeValue;

		// Insert the fallback tag into a parent for helping to find the script tags.
		let parent = document.createElement( 'div' );
		parent.innerHTML = slot_fallback_tag;

		// Make our ad visible. Needed by IPONWEB to calculate the width of the container.
		target.style.position = 'relative';
		target.style.visibility = 'visible';

		// Inserting into target.
		target.innerHTML = parent.innerHTML;

		// Process any scripts in the tag.
		let scripts = parent.querySelectorAll( 'script' );
		scripts.forEach( function ( script ) {
			script.parentNode.removeChild( script );

			let scriptTag = document.createElement( 'script' );

			if ( script.src ) {
				scriptTag.src = script.src;
			} else if ( script.textContent ) {
				scriptTag.textContent = script.textContent;
			} else if ( script.innerText ) {
				scriptTag.innerText = script.innerText;
			}

			document.body.appendChild( scriptTag );
		} );
	};

	wordads.getChildrenByTag = function ( el, tag ) {
		let children = [];

		el.childNodes.forEach( ( child ) => {
			if ( child.nodeName === tag.toUpperCase() ) {
				children.push( child );
			}
		} );

		return children;
	};

	wordads.getFloatingElements = function ( el ) {
		let floating = [];

		// Get child nodes recursive.
		let children = el.getElementsByTagName( '*' );

		for ( let i = 0; i < children.length; i++ ) {
			let child = children[ i ];

			let computed = getComputedStyle( child );
			let position = computed.getPropertyValue( 'position' );
			let float = computed.getPropertyValue( 'float' );

			if ( position === 'relative' || position === 'absolute' || float !== 'none' ) {
				floating.push( child );
			}
		}

		return floating;
	};

	wordads.getElementGlobalPosition = function ( el ) {
		let rect = el.getBoundingClientRect();

		return {
			top: rect.top + window.scrollY,
			left: rect.left + window.scrollX,
			bottom: rect.top + window.scrollY + rect.height,
			right: rect.left + window.scrollX + rect.width,
		};
	};

	wordads.collidesWithElements = function ( target, elements ) {
		let targetRect = wordads.getElementGlobalPosition( target );

		let collides = false;

		elements.forEach( ( el ) => {
			let collideRect = wordads.getElementGlobalPosition( el );

			if (
				! (
					targetRect.bottom < collideRect.top ||
					targetRect.top > collideRect.bottom ||
					targetRect.right < collideRect.left ||
					targetRect.left > collideRect.left
				)
			) {
				collides = true;
			}
		} );

		return collides;
	};

	wordads.initInlineAds = function () {
		wordads.log( 'Initializing Inline Ads' );

		if ( wordads.initialized ) {
			wordads.log( 'Already initialized' );
			return;
		}

		wordads.initialized = true;

		// Check if feature is enabled.
		if ( ! wa_smart.inline.enabled ) {
			return;
		}

		// Check for inline ads marker.
		let marker = document.getElementById( 'wordads-inline-marker' );

		// Stop if no marker is found.
		if ( ! marker ) {
			wordads.trackStat( 'inline_no_marker' );
			return;
		}

		// Get the post content area element based on marker position.
		let post = marker.parentElement;

		// Remove marker, we don't need it anymore.
		marker.remove();

		// Set threshold for maximum slots.
		let maxSlots = wa_smart.inline.max_slots;
		let maxBlazeSlots = wa_smart.inline.max_blaze_slots;
		let slotCount = 0;

		// Calculate insertion intervals based on ratio of viewport height.
		let viewportHeight = window.innerHeight;

		let initialViewportRatio = 1.35;
		let initialInsertionInterval = Math.ceil( viewportHeight * initialViewportRatio );

		let viewportRatio = 2.5;
		let insertionInterval = Math.ceil( viewportHeight * viewportRatio );

		// Calculate initial threshold.
		let postOffset = post.getBoundingClientRect().top + window.scrollY;
		let minThreshold = postOffset + initialInsertionInterval;

		// Loop through content to find slots to insert.
		let paras = wordads.getChildrenByTag( post, 'p' );

		// Get floating elements.
		let floating = wordads.getFloatingElements( post );

		paras.forEach( ( p ) => {
			let offset = p.getBoundingClientRect().top + window.scrollY;
			let previous = p.previousElementSibling;

			if (
				offset > minThreshold &&
				slotCount < maxSlots &&
				previous.nodeName === 'P' &&
				! wordads.collidesWithElements( p, floating )
			) {
				if ( maxBlazeSlots > slotCount ) {
					wordads.insertInlineAdBefore( p );
					wordads.trackStat( 'render_inline' );
				} else {
					// Need to wrap first.
					let target = document.createElement( 'div' );
					target.className = 'wordads-ad-wrapper';
					p.insertAdjacentElement( 'beforebegin', target );

					wordads.insertFallbackAd( target, 'inline' );
					wordads.trackStat( 'render_inline_fallback' );
				}

				minThreshold = offset + insertionInterval;
				slotCount++;
			}
		} );

		if ( slotCount === 0 ) {
			wordads.trackStat( 'inline_no_insert' );
		}
	};

	wordads.isOpenWrapReady = function () {
		return typeof PWT !== 'undefined' && typeof owpbjs !== 'undefined';
	};

	wordads.renderOpenWrap = function ( bid, tagId ) {
		try {
			wordads.log( 'Inserting OpenWrap winner:' );
			let i = document.createElement( 'iframe' );
			i.style.width = bid.width;
			i.style.height = bid.height;
			i.style.overflow = 'hidden';
			i.setAttribute( 'frameBorder', 0 ); //to remove the default iframe border
			i.setAttribute( 'scrolling', 'no' ); //to remove any scrollbars
			document.getElementById( tagId ).appendChild( i );
			PWT.displayCreative( i.contentWindow.document, bid.adserverTargeting.pwtsid );
			i.contentWindow.document.body.style.padding = '0';
			i.contentWindow.document.body.style.margin = '0';
		} catch ( e ) {}
	};

	wordads.getOpenWrapWinner = function ( tagId ) {
		if ( wordads.isOpenWrapReady() ) {
			return owpbjs.getHighestCpmBids( tagId )[ 0 ];
		} else {
			return null;
		}
	};

	wordads.handleNoAd = function ( data ) {
		let el = document.getElementById( data.tagId );

		if ( el ) {
			let target = el.closest( '.wordads-ad-wrapper' );
			let slotType = el.classList.contains( 'wordads-ad-inline' ) ? 'inline' : 'belowpost';

			let bid = wordads.getOpenWrapWinner( data.tagId );

			if ( slotType === 'inline' && bid ) {
				wordads.renderOpenWrap( bid, data.tagId );
			} else {
				wordads.log( 'Running fallback' );
				wordads.insertFallbackAd( target, slotType );
			}
		}

		if ( data.pixelURL ) {
			let xhr = new XMLHttpRequest();
			xhr.open( 'GET', data.pixelURL );
			xhr.send();
		}
	};

	wordads.handleAdLoaded = function ( data ) {
		let el = document.getElementById( data.tagId );

		if ( ! el ) {
			return;
		}

		let wrapper = el.closest( '.wordads-ad-wrapper' );
		wrapper.style.position = 'relative';
		wrapper.style.visibility = 'visible';
	};

	wordads.handlePostMessage = function ( msg ) {
		if ( typeof msg.data !== 'object' ) {
			return;
		}

		if ( msg.data.type !== 'wa-inline-frame' ) {
			return;
		}

		let iframes = document.getElementsByTagName( 'iframe' );

		for ( let i = 0; i < iframes.length; i++ ) {
			if ( iframes[ i ].contentWindow === msg.source ) {
				// Set the frame height. Use next highest int to fix rounding issues with Firefox.
				iframes[ i ].style.height = Math.ceil( msg.data.height ) + 'px';

				// Enable full-width ad.
				let target = iframes[ i ].closest( '.wordads-ad' );

				if ( target ) {
					if ( ! target.classList.contains( 'wordads-ad-responsive' ) ) {
						target.classList.add( 'wordads-ad-responsive' );
					}

					// Set max width for inner elements if provided.
					if ( msg.data.maxWidth ) {
						target
							.querySelectorAll( '.wordads-ad-title, .wordads-ad-controls' )
							.forEach( ( el ) => {
								el.style.maxWidth = msg.data.maxWidth;
							} );
					}
				}

				// Exit loop.
				break;
			}
		}
	};

	wordads.initConsent = function () {
		// USP API.
		// Note: We may need to spin here until USP API is ready.
		if ( window.__uspapi ) {
			window.__uspapi( 'getUSPData', 1, function ( uspData, success ) {
				if ( success && uspData.uspString ) {
					wordads.usPrivacy = uspData.uspString;
				}
			} );
		}

		// TCF API.
		if ( window.__tcfapi ) {
			window.__tcfapi( 'addEventListener', 2, function ( tcData, success ) {
				if ( success && tcData.gdprApplies ) {
					wordads.tcData = tcData;
				}
			} );
		}
	};

	wordads.initSmart = function () {
		wordads.log( 'Initializing Smart' );

		// Setup Smart.
		sas.cmd.push( function () {
			sas.setup( {
				networkid: wa_smart.network_id,
				domain: 'https://www15.smartadserver.com',
				async: true,
			} );
		} );

		// Initialize handlers.
		sas.cmd.push( function () {
			sas.events.on( 'noad', function ( data ) {
				wordads.log( 'Got NoAd:' );
				wordads.log( data );

				wordads.handleNoAd( data );
			} );
		} );

		sas.cmd.push( function () {
			sas.events.on( 'load', function ( data ) {
				wordads.log( 'Got Ad:' );
				wordads.log( data );
				wordads.handleAdLoaded( data );
			} );
		} );
	};

	wordads.initOpenWrapAsync = function () {
		wordads.log( 'Initializing OpenWrap' );
		let purl = window.location.href;
		let url = '//ads.pubmatic.com/AdServer/js/pwt/164116/11712';
		let profileVersionId = '';
		if ( purl.indexOf( 'pwtv=' ) > 0 ) {
			let regexp = /pwtv=(.*?)(&|$)/g;
			let matches = regexp.exec( purl );
			if ( matches.length >= 2 && matches[ 1 ].length > 0 ) {
				profileVersionId = '/' + matches[ 1 ];
			}
		}
		let wtads = document.createElement( 'script' );
		wtads.async = true;
		wtads.type = 'text/javascript';
		wtads.src = url + profileVersionId + '/pwt.js';
		let node = document.getElementsByTagName( 'script' )[ 0 ];
		node.parentNode.insertBefore( wtads, node );
	};

	wordads.throttle = function ( func, delay ) {
		let wait = false;

		return ( ...args ) => {
			if ( wait ) {
				return;
			}

			func( ...args );
			wait = true;
			setTimeout( () => {
				wait = false;
			}, delay );
		};
	};

	wordads.isElementInLazyViewport = function ( el ) {
		// Lazy Viewport spans from 1vw before to 1vw after the current viewport.
		let viewportHeight = window.innerHeight;
		let scrollPos = window.scrollY;
		let minLazyViewport = scrollPos - viewportHeight;
		let maxLazyViewport = scrollPos + viewportHeight * 2;
		let elPos = wordads.getElementGlobalPosition( el );

		return ! ( elPos.bottom <= minLazyViewport || elPos.top >= maxLazyViewport );
	};

	wordads.processAds = function () {
		if ( wordads.slots.length === 0 ) {
			return;
		}

		wordads.slots.forEach( ( slot ) => {
			if ( slot.isLoaded ) {
				return;
			}

			let inView = slot.isLazy ? wordads.isElementInLazyViewport( slot.element ) : true;

			if ( inView ) {
				wordads.log( 'Calling ad [' + slot.tagId + ']' );
				slot.isLoaded = true;
				wordads.call( slot.tagId );
			}
		} );
	};

	wordads.init = function () {
		wordads.initConsent();
		wordads.initSmart();

		if ( wa_smart.openwrap_enabled ) {
			window.PWT = {};
			window.PWT.jsLoaded = function () {
				wordads.log( 'PWT loaded' );
				wordads.initInlineAds();
			};

			wordads.initOpenWrapAsync();
		} else {
			wordads.initInlineAds();
		}
	};

	// Register event listeners.
	document.addEventListener( 'scroll', wordads.throttle( wordads.processAds, 250 ) );
	document.addEventListener( 'resize', wordads.throttle( wordads.processAds, 250 ) );
	document.addEventListener( 'DOMContentLoaded', function () {
		wordads.init();
	} );
	window.addEventListener( 'message', wordads.handlePostMessage );
} )();
;
( function() {
	var cookieValue = document.cookie.replace( /(?:(?:^|.*;\s*)eucookielaw\s*\=\s*([^;]*).*$)|^.*$/, '$1' );
	var overlay = document.querySelector( '#eu-cookie-law' );
	var container = document.querySelector( '.widget_eu_cookie_law_widget' );
	var initialScrollPosition, scrollFunction;

	function remove( el ) {
		return el && el.parentElement && el.parentElement.removeChild( el );
	}

	function triggerDismissEvent() {
		try {
			const dismissEvent = new Event( 'eucookielaw-dismissed' );
			document.dispatchEvent( dismissEvent );
		} catch ( err ) { }
	}

	function removeOverlay() {
		remove( overlay );
		triggerDismissEvent();
	}

	function fade( el, type, fn ) {
		var duration = 400;

		el.style.display = 'block';
		el.style.transitionProperty = 'opacity';
		el.style.transitionDuration = duration + 'ms';
		el.style.opacity = type === 'in' ? 0 : 1;

		// Double rAF to ensure styles are applied cross-browser.
		requestAnimationFrame( function () {
			requestAnimationFrame( function() {
				el.style.opacity = type === 'in' ? 1 : 0;
				// Wait for animation.
				setTimeout( function () {
					// Clean up.
					el.style.removeProperty( 'opacity' );
					el.style.removeProperty( 'transition-property' );
					el.style.removeProperty( 'transition-duration' );

					if ( type === 'out' ) {
						el.style.display = 'none';
					}

					if ( typeof fn === 'function' ) {
						fn();
					}
				}, duration + 50 );
			} );
		} );
	}

	function appendWidget() {
		document.body.appendChild( container );
		overlay.style.display = 'block';
		fade( container, 'in' );
	}

	if ( typeof wp !== 'undefined' && !! wp.customize ) {
		appendWidget();
		return;
	}

	if ( ! overlay || ! container ) {
		return;
	}

	if ( overlay.classList.contains( 'ads-active' ) ) {
		var adsCookieValue = document.cookie.replace( /(?:(?:^|.*;\s*)personalized-ads-consent\s*\=\s*([^;]*).*$)|^.*$/, '$1' );
		if ( cookieValue !== '' && adsCookieValue !== '' ) {
			removeOverlay();
		}
	} else if ( cookieValue !== '' ) {
		removeOverlay();
	}

	appendWidget();

	overlay.querySelector( 'form' ).addEventListener( 'submit', accept );

	if ( overlay.classList.contains( 'hide-on-scroll' ) ) {
		initialScrollPosition = window.pageYOffset;

		scrollFunction = function() {
			if ( Math.abs( window.pageYOffset - initialScrollPosition ) > 50 ) {
				accept();
			}
		};

		window.addEventListener( 'scroll', scrollFunction );
	} else if ( overlay.classList.contains( 'hide-on-time' ) ) {
		var timeout = parseInt( overlay.getAttribute( 'data-hide-timeout' ), 10 ) || 0;
		setTimeout( accept, timeout * 1000 );
	}

	var accepted = false;
	function accept( event ) {
		if ( accepted ) {
			return;
		}
		accepted = true;

		if ( event && event.preventDefault ) {
			event.preventDefault();
		}

		if ( overlay.classList.contains( 'hide-on-scroll' ) ) {
			window.removeEventListener( 'scroll', scrollFunction );
		}

		var expireTime = new Date();
		var consentExpiration = parseInt( overlay.getAttribute( 'data-consent-expiration' ), 10 ) || 0;
		expireTime.setTime( expireTime.getTime() + ( consentExpiration * 24 * 60 * 60 * 1000 ) );

		document.cookie = 'eucookielaw=' + expireTime.getTime() + ';path=/;expires=' + expireTime.toGMTString();
		if ( overlay.classList.contains( 'ads-active' ) && overlay.classList.contains( 'hide-on-button' ) ) {
			document.cookie = 'personalized-ads-consent=' + expireTime.getTime() + ';path=/;expires=' + expireTime.toGMTString();
		}

		fade( overlay, 'out', function() {
			removeOverlay();
			remove( container );
		} );
	}
} )();
;
/* global wpcom_reblog */

var jetpackLikesWidgetBatch = [];
var jetpackLikesMasterReady = false;

// Due to performance problems on pages with a large number of widget iframes that need to be loaded,
// we are limiting the processing at any instant to unloaded widgets that are currently in viewport,
// plus this constant that will allow processing of widgets above and bellow the current fold.
// This aim of it is to improve the UX and hide the transition from unloaded to loaded state from users.
var jetpackLikesLookAhead = 2000; // pixels

// Keeps track of loaded comment likes widget so we can unload them when they are scrolled out of view.
var jetpackCommentLikesLoadedWidgets = [];

var jetpackLikesDocReadyPromise = new Promise( resolve => {
	if ( document.readyState !== 'loading' ) {
		resolve();
	} else {
		window.addEventListener( 'DOMContentLoaded', () => resolve() );
	}
} );

function JetpackLikesPostMessage( message, target ) {
	if ( typeof message === 'string' ) {
		try {
			message = JSON.parse( message );
		} catch ( e ) {
			return;
		}
	}

	if ( target && typeof target.postMessage === 'function' ) {
		try {
			target.postMessage(
				JSON.stringify( {
					type: 'likesMessage',
					data: message,
				} ),
				'*'
			);
		} catch ( e ) {
			return;
		}
	}
}

function JetpackLikesBatchHandler() {
	const requests = [];
	document.querySelectorAll( 'div.jetpack-likes-widget-unloaded' ).forEach( widget => {
		if ( jetpackLikesWidgetBatch.indexOf( widget.id ) > -1 ) {
			return;
		}

		if ( ! jetpackIsScrolledIntoView( widget ) ) {
			return;
		}

		jetpackLikesWidgetBatch.push( widget.id );

		var regex = /like-(post|comment)-wrapper-(\d+)-(\d+)-(\w+)/,
			match = regex.exec( widget.id ),
			info;

		if ( ! match || match.length !== 5 ) {
			return;
		}

		info = {
			blog_id: match[ 2 ],
			width: widget.width,
		};

		if ( 'post' === match[ 1 ] ) {
			info.post_id = match[ 3 ];
		} else if ( 'comment' === match[ 1 ] ) {
			info.comment_id = match[ 3 ];
		}

		info.obj_id = match[ 4 ];

		requests.push( info );
	} );

	if ( requests.length > 0 ) {
		JetpackLikesPostMessage(
			{ event: 'initialBatch', requests: requests },
			window.frames[ 'likes-master' ]
		);
	}
}

function JetpackLikesMessageListener( event ) {
	let message = event && event.data;
	if ( typeof message === 'string' ) {
		try {
			message = JSON.parse( message );
		} catch ( err ) {
			return;
		}
	}

	const type = message && message.type;
	const data = message && message.data;

	if ( type !== 'likesMessage' || typeof data.event === 'undefined' ) {
		return;
	}

	// We only allow messages from one origin
	const allowedOrigin = 'https://widgets.wp.com';
	if ( allowedOrigin !== event.origin ) {
		return;
	}

	switch ( data.event ) {
		case 'masterReady':
			jetpackLikesDocReadyPromise.then( () => {
				jetpackLikesMasterReady = true;

				const stylesData = {
					event: 'injectStyles',
				};
				const sdTextColor = document.querySelector( '.sd-text-color' );
				const sdLinkColor = document.querySelector( '.sd-link-color' );
				const sdTextColorStyles = ( sdTextColor && getComputedStyle( sdTextColor ) ) || {};
				const sdLinkColorStyles = ( sdLinkColor && getComputedStyle( sdLinkColor ) ) || {};

				if ( document.querySelectorAll( 'iframe.admin-bar-likes-widget' ).length > 0 ) {
					JetpackLikesPostMessage( { event: 'adminBarEnabled' }, window.frames[ 'likes-master' ] );

					const bgSource = document.querySelector(
						'#wpadminbar .quicklinks li#wp-admin-bar-wpl-like > a'
					);

					const wpAdminBar = document.querySelector( '#wpadminbar' );

					stylesData.adminBarStyles = {
						background: bgSource && getComputedStyle( bgSource ).background,
						isRtl: wpAdminBar && getComputedStyle( wpAdminBar ).direction === 'rtl',
					};
				}

				// enable reblogs if they are enabled for the page
				if ( document.body.classList.contains( 'jetpack-reblog-enabled' ) ) {
					JetpackLikesPostMessage( { event: 'reblogsEnabled' }, window.frames[ 'likes-master' ] );
				}

				stylesData.textStyles = {
					color: sdTextColorStyles[ 'color' ],
					fontFamily: sdTextColorStyles[ 'font-family' ],
					fontSize: sdTextColorStyles[ 'font-size' ],
					direction: sdTextColorStyles[ 'direction' ],
					fontWeight: sdTextColorStyles[ 'font-weight' ],
					fontStyle: sdTextColorStyles[ 'font-style' ],
					textDecoration: sdTextColorStyles[ 'text-decoration' ],
				};

				stylesData.linkStyles = {
					color: sdLinkColorStyles[ 'color' ],
					fontFamily: sdLinkColorStyles[ 'font-family' ],
					fontSize: sdLinkColorStyles[ 'font-size' ],
					textDecoration: sdLinkColorStyles[ 'text-decoration' ],
					fontWeight: sdLinkColorStyles[ 'font-weight' ],
					fontStyle: sdLinkColorStyles[ 'font-style' ],
				};

				JetpackLikesPostMessage( stylesData, window.frames[ 'likes-master' ] );

				JetpackLikesBatchHandler();
			} );

			break;

		case 'showLikeWidget': {
			const placeholder = document.querySelector( `#${ data.id } .likes-widget-placeholder` );
			if ( placeholder ) {
				placeholder.style.display = 'none';
			}
			break;
		}

		case 'showCommentLikeWidget': {
			const placeholder = document.querySelector( `#${ data.id } .likes-widget-placeholder` );
			if ( placeholder ) {
				placeholder.style.display = 'none';
			}
			break;
		}

		case 'killCommentLikes':
			// If kill switch for comment likes is enabled remove all widgets wrappers and `Loading...` placeholders.
			document
				.querySelectorAll( '.jetpack-comment-likes-widget-wrapper' )
				.forEach( wrapper => wrapper.remove() );
			break;

		case 'clickReblogFlair':
			if ( wpcom_reblog && typeof wpcom_reblog.toggle_reblog_box_flair === 'function' ) {
				wpcom_reblog.toggle_reblog_box_flair( data.obj_id, data.post_id );
			}
			break;

		case 'hideOtherGravatars': {
			hideLikersPopover();
			break;
		}

		case 'showOtherGravatars': {
			const container = document.querySelector( '#likes-other-gravatars' );

			if ( ! container ) {
				break;
			}

			const newLayout = container.classList.contains( 'wpl-new-layout' );

			const list = container.querySelector( 'ul' );

			container.style.display = 'none';
			list.innerHTML = '';

			if ( newLayout ) {
				container
					.querySelectorAll( '.likes-text span' )
					.forEach( item => ( item.textContent = data.totalLikesLabel ) );
			} else {
				container
					.querySelectorAll( '.likes-text span' )
					.forEach( item => ( item.textContent = data.total ) );
			}

			( data.likers || [] ).forEach( async ( liker, index ) => {
				if ( liker.profile_URL.substr( 0, 4 ) !== 'http' ) {
					// We only display gravatars with http or https schema
					return;
				}

				const element = document.createElement( 'li' );
				// Appending element before fetching avatar_URL to avoid racing conditions on the list order
				list.append( element );

				try {
					const response = await fetch( liker.avatar_URL, { method: 'HEAD' } );
					if ( !response.ok ) {
						// Image doesn't exist, remove the element
						element.remove();
						return;
					}
				} catch ( error ) {
					// Error occurred while checking image existence, remove the element
					element.remove();
					return;
				}

				if ( newLayout ) {
					element.innerHTML = `
					<a href="${ encodeURI( liker.profile_URL ) }" rel="nofollow" target="_parent" class="wpl-liker">
						<img src="${ encodeURI( liker.avatar_URL ) }"
							alt=""
							style="width: 28px; height: 28px;" />
						<span></span>
					</a>
				`;
				} else {
					element.innerHTML = `
					<a href="${ encodeURI( liker.profile_URL ) }" rel="nofollow" target="_parent" class="wpl-liker">
						<img src="${ encodeURI( liker.avatar_URL ) }"
							alt=""
							style="width: 30px; height: 30px; padding-right: 3px;" />
					</a>
				`;
				}


				// Add some extra attributes through native methods, to ensure strings are sanitized.
				element.classList.add( liker.css_class );
				element.querySelector( 'img' ).alt = data.avatarAltTitle.replace( '%s', liker.name );

				if ( newLayout ) {
					element.querySelector( 'span' ).innerText = liker.name;
				}

				if ( index === data.likers.length - 1 ) {
					element.addEventListener( 'keydown', ( e ) => {
						if ( e.key === 'Tab' && ! e.shiftKey ) {
							e.preventDefault();
							hideLikersPopover();

							JetpackLikesPostMessage(
								{ event: 'focusLikesCount', parent: data.parent },
								window.frames[ 'likes-master' ]
							);
						}
					} );
				}
			} );

			const positionPopup = function() {

				const containerStyle = getComputedStyle(container);
				const isRtl = containerStyle.direction === 'rtl';

				const el = document.querySelector(`*[name='${ data.parent }']`);
				const rect = el.getBoundingClientRect();
				const win = el.ownerDocument.defaultView;
				const offset = {
					top: rect.top + win.pageYOffset,
					left: rect.left + win.pageXOffset,
				};

				if ( newLayout ) {
					container.style.top = offset.top + data.position.top - 1 + 'px';

					if ( isRtl ) {
						const visibleAvatarsCount = data && data.likers ? Math.min(data.likers.length, 5) : 0;
						// 24px is the width of the avatar + 4px is the padding between avatars
						container.style.left = offset.left + data.position.left + 24 * visibleAvatarsCount + 4 + 'px';
						container.style.transform = 'translateX(-100%)';
					} else {
						container.style.left = offset.left + data.position.left + 'px';
					}
				} else {
					container.style.left = offset.left + data.position.left - 10 + 'px';
					container.style.top = offset.top + data.position.top - 33 + 'px';
				}

				// Container width - padding
				const initContainerWidth = data.width - 20;
				const rowLength = Math.floor(initContainerWidth / 37);
				// # of rows + (avatar + avatar padding) + text above + container padding
				let height = Math.ceil(data.likers.length / rowLength) * 37 + 17 + 22;
				if ( height > 204 ) {
					height = 204;
				}

				if ( !newLayout ) {
					// Avatars + padding
					const containerWidth = rowLength * 37 + 13;
					container.style.height = height + 'px';
					container.style.width = containerWidth + 'px';

					const listWidth = rowLength * 37;
					list.style.width = listWidth + 'px';
				}

				container.style.display = 'block';
				container.setAttribute( 'aria-hidden', 'false' );
			}

			positionPopup();
			container.focus();

			const debounce = function( func, wait ) {
				var timeout;
				return function() {
					var context = this;
					var args = arguments;
					clearTimeout( timeout );
					timeout = setTimeout( function() {
						func.apply( context, args );
					}, wait );
				};
			};

			const debouncedPositionPopup = debounce( positionPopup, 100 );

			// Keep a reference of this function in the element itself
			// so that we can destroy it later
			container.__resizeHandler = debouncedPositionPopup;

			// When window is resized, resize the popup.
			window.addEventListener( "resize", debouncedPositionPopup );
		}
	}
}

window.addEventListener( 'message', JetpackLikesMessageListener );

function hideLikersPopover() {
	const container = document.querySelector( '#likes-other-gravatars' );

	if ( container ) {
		container.style.display = 'none';
		container.setAttribute( 'aria-hidden', 'true' );

		// Remove the resize event listener and cleanup.
		const resizeHandler = container.__resizeHandler;
		if ( resizeHandler ) {
			window.removeEventListener( "resize", resizeHandler );
			delete container.__resizeHandler;
		}
	}
}

document.addEventListener( 'click', hideLikersPopover );

function JetpackLikesWidgetQueueHandler() {
	var wrapperID;

	if ( ! jetpackLikesMasterReady ) {
		setTimeout( JetpackLikesWidgetQueueHandler, 500 );
		return;
	}

	// Restore widgets to initial unloaded state when they are scrolled out of view.
	jetpackUnloadScrolledOutWidgets();

	var unloadedWidgetsInView = jetpackGetUnloadedWidgetsInView();

	if ( unloadedWidgetsInView.length > 0 ) {
		// Grab any unloaded widgets for a batch request
		JetpackLikesBatchHandler();
	}

	for ( var i = 0, length = unloadedWidgetsInView.length; i <= length - 1; i++ ) {
		wrapperID = unloadedWidgetsInView[ i ].id;

		if ( ! wrapperID ) {
			continue;
		}

		jetpackLoadLikeWidgetIframe( wrapperID );
	}
}

function jetpackLoadLikeWidgetIframe( wrapperID ) {
	if ( typeof wrapperID === 'undefined' ) {
		return;
	}

	const wrapper = document.querySelector( '#' + wrapperID );
	wrapper.querySelectorAll( 'iframe' ).forEach( iFrame => iFrame.remove() );

	const placeholder = wrapper.querySelector( '.likes-widget-placeholder' );

	// Post like iframe
	if ( placeholder && placeholder.classList.contains( 'post-likes-widget-placeholder' ) ) {
		const postLikesFrame = document.createElement( 'iframe' );

		postLikesFrame.classList.add( 'post-likes-widget', 'jetpack-likes-widget' );
		postLikesFrame.name = wrapper.dataset.name;
		postLikesFrame.src = wrapper.dataset.src;
		postLikesFrame.height = '55px';
		postLikesFrame.width = '100%';
		postLikesFrame.frameBorder = '0';
		postLikesFrame.scrolling = 'no';
		postLikesFrame.title = wrapper.dataset.title;

		placeholder.after( postLikesFrame );
	}

	// Comment like iframe
	if ( placeholder.classList.contains( 'comment-likes-widget-placeholder' ) ) {
		const commentLikesFrame = document.createElement( 'iframe' );

		commentLikesFrame.class = 'comment-likes-widget-frame jetpack-likes-widget-frame';
		commentLikesFrame.name = wrapper.dataset.name;
		commentLikesFrame.src = wrapper.dataset.src;
		commentLikesFrame.height = '18px';
		commentLikesFrame.width = '100%';
		commentLikesFrame.frameBorder = '0';
		commentLikesFrame.scrolling = 'no';

		wrapper.querySelector( '.comment-like-feedback' ).after( commentLikesFrame );

		jetpackCommentLikesLoadedWidgets.push( commentLikesFrame );
	}

	wrapper.classList.remove( 'jetpack-likes-widget-unloaded' );
	wrapper.classList.add( 'jetpack-likes-widget-loading' );

	wrapper.querySelector( 'iframe' ).addEventListener( 'load', e => {
		JetpackLikesPostMessage(
			{ event: 'loadLikeWidget', name: e.target.name, width: e.target.width },
			window.frames[ 'likes-master' ]
		);

		wrapper.classList.remove( 'jetpack-likes-widget-loading' );
		wrapper.classList.add( 'jetpack-likes-widget-loaded' );
	} );
}

function jetpackGetUnloadedWidgetsInView() {
	const unloadedWidgets = document.querySelectorAll( 'div.jetpack-likes-widget-unloaded' );

	return [ ...unloadedWidgets ].filter( item => jetpackIsScrolledIntoView( item ) );
}

function jetpackIsScrolledIntoView( element ) {
	const top = element.getBoundingClientRect().top;
	const bottom = element.getBoundingClientRect().bottom;

	// Allow some slack above and bellow the fold with jetpackLikesLookAhead,
	// with the aim of hiding the transition from unloaded to loaded widget from users.
	return top + jetpackLikesLookAhead >= 0 && bottom <= window.innerHeight + jetpackLikesLookAhead;
}

function jetpackUnloadScrolledOutWidgets() {
	for ( let i = jetpackCommentLikesLoadedWidgets.length - 1; i >= 0; i-- ) {
		const currentWidgetIframe = jetpackCommentLikesLoadedWidgets[ i ];

		if ( ! jetpackIsScrolledIntoView( currentWidgetIframe ) ) {
			const widgetWrapper =
				currentWidgetIframe &&
				currentWidgetIframe.parentElement &&
				currentWidgetIframe.parentElement.parentElement;

			// Restore parent class to 'unloaded' so this widget can be picked up by queue manager again if needed.
			widgetWrapper.classList.remove( 'jetpack-likes-widget-loaded' );
			widgetWrapper.classList.remove( 'jetpack-likes-widget-loading' );
			widgetWrapper.classList.add( 'jetpack-likes-widget-unloaded' );

			// Bring back the loading placeholder into view.
			widgetWrapper
				.querySelectorAll( '.comment-likes-widget-placeholder' )
				.forEach( item => ( item.style.display = 'block' ) );

			// Remove it from the list of loaded widgets.
			jetpackCommentLikesLoadedWidgets.splice( i, 1 );

			// Remove comment like widget iFrame.
			currentWidgetIframe.remove();
		}
	}
}

var jetpackWidgetsDelayedExec = function ( after, fn ) {
	var timer;
	return function () {
		clearTimeout( timer );
		timer = setTimeout( fn, after );
	};
};

var jetpackOnScrollStopped = jetpackWidgetsDelayedExec( 250, JetpackLikesWidgetQueueHandler );

// Load initial batch of widgets, prior to any scrolling events.
JetpackLikesWidgetQueueHandler();

// Add event listener to execute queue handler after scroll.
window.addEventListener( 'scroll', jetpackOnScrollStopped, true );
;
!function(){var e=document.currentScript;function t(t){var n=document.createElement("script"),o=e||document.getElementsByTagName("script")[0];n.setAttribute("async",!0),n.setAttribute("src",t),o.parentNode.insertBefore(n,o)}function n(e,t){return Element.prototype.matches?e.matches(t):Element.prototype.msMatchesSelector?e.msMatchesSelector(t):void 0}function o(e,t){if(e.closest)return e.closest(t);var o=e;do{if(n(o,t))return o;o=o.parentElement||o.parentNode}while(null!==o&&1===o.nodeType);return null}function i(e,t){for(var n=0;n<e.length;n++)t(e[n],n,e)}var r=".sharing-hidden .inner",s="data-sharing-more-button-id";function a(e){this.button=e,this.pane=o(e,"div").querySelector(r),this.openedBy=null,this.recentlyOpenedByHover=!1,a.instances.push(this),this.pane.setAttribute(s,a.instances.length-1),this.attachHandlers()}if(a.instances=[],a.hoverOpenDelay=200,a.recentOpenDelay=400,a.hoverCloseDelay=300,a.instantiateOrReuse=function(e){var t=o(e,"div").querySelector(r),n=t&&t.getAttribute(s),i=a.instances[n];return i||new a(e)},a.getButtonInstanceFromPane=function(e){var t=e&&e.getAttribute(s);return a.instances[t]},a.closeAll=function(){for(var e=0;e<a.instances.length;e++)a.instances[e].close()},a.prototype.open=function(){var e,t,n=[0,0];function o(e){var t=e.getBoundingClientRect();return[t.left+(window.scrollX||window.pageXOffset||0),t.top+(window.scrollY||window.pageYOffset||0)]}function i(e,t){return parseInt(getComputedStyle(e).getPropertyValue(t)||0)}for(e=o(this.button),t=this.button.offsetParent||document.documentElement;t&&(t===document.body||t===document.documentElement)&&"static"===getComputedStyle(t).getPropertyValue("position");)t=t.parentNode;t&&t!==this.button&&1===t.nodeType&&(n=[(n=o(t))[0]+i(t,"border-left-width"),n[1]+i(t,"border-top-width")]);var r,s=e[0]-n[0]-i(this.button,"margin-left"),a=e[1]-n[1]-i(this.button,"margin-top");this.pane.style.left=s+"px",this.pane.style.top=a+this.button.offsetHeight+3+"px",(r=this.pane)&&r.style.removeProperty("display")},a.prototype.close=function(){var e;(e=this.pane)&&(e.style.display="none"),this.openedBy=null},a.prototype.toggle=function(){var e;(e=this.pane)&&"none"!==e.style.display?this.close():this.open()},a.prototype.nonHoverOpen=function(){clearTimeout(this.openTimer),clearTimeout(this.closeTimer),this.recentlyOpenedByHover?(this.recentlyOpenedByHover=!1,clearTimeout(this.hoverOpenTimer),this.open()):this.toggle()},a.prototype.resetCloseTimer=function(){clearTimeout(this.closeTimer),this.closeTimer=setTimeout(this.close.bind(this),a.hoverCloseDelay)},a.prototype.attachHandlers=function(){this.buttonClick=function(e){e.preventDefault(),e.stopPropagation(),this.openedBy="click",this.nonHoverOpen()}.bind(this),this.buttonKeydown=function(e){13!==e.keyCode&&32!==e.keyCode||(e.preventDefault(),e.stopPropagation(),this.openedBy="keydown",this.nonHoverOpen())}.bind(this),this.buttonEnter=function(){this.openedBy||(this.openTimer=setTimeout(function(){this.open(),this.openedBy="hover",this.recentlyOpenedByHover=!0,this.hoverOpenTimer=setTimeout(function(){this.recentlyOpenedByHover=!1}.bind(this),a.recentOpenDelay)}.bind(this),a.hoverOpenDelay)),clearTimeout(this.closeTimer)}.bind(this),this.buttonLeave=function(){"hover"===this.openedBy&&this.resetCloseTimer(),clearTimeout(this.openTimer)}.bind(this),this.paneEnter=function(){clearTimeout(this.closeTimer)}.bind(this),this.paneLeave=function(){"hover"===this.openedBy&&this.resetCloseTimer()}.bind(this),this.documentClick=function(){this.close()}.bind(this),this.button.addEventListener("click",this.buttonClick),this.button.addEventListener("keydown",this.buttonKeydown),document.addEventListener("click",this.documentClick),void 0===document.ontouchstart&&(this.button.addEventListener("mouseenter",this.buttonEnter),this.button.addEventListener("mouseleave",this.buttonLeave),this.pane.addEventListener("mouseenter",this.paneEnter),this.pane.addEventListener("mouseleave",this.paneLeave))},window.sharing_js_options&&window.sharing_js_options.counts){var c={done_urls:[],get_counts:function(){var e,n,o,i,r;if("undefined"!=typeof WPCOM_sharing_counts)for(e in WPCOM_sharing_counts)if(o=WPCOM_sharing_counts[e],void 0===c.done_urls[o]){for(i in n={pinterest:[window.location.protocol+"//api.pinterest.com/v1/urls/count.json?callback=WPCOMSharing.update_pinterest_count&url="+encodeURIComponent(e)]})if(document.querySelector("a[data-shared=sharing-"+i+"-"+o+"]")){for(;r=n[i].pop();)t(r);window.sharing_js_options.is_stats_active&&c.bump_sharing_count_stat(i)}c.done_urls[o]=!0}},update_pinterest_count:function(e){void 0!==e.count&&1*e.count>0&&c.inject_share_count("sharing-pinterest-"+WPCOM_sharing_counts[e.url],e.count)},inject_share_count:function(e,t){i(document.querySelectorAll("a[data-shared="+e+"] > span"),(function(e){var n,o=e.querySelector(".share-count");(n=o)&&n.parentNode&&n.parentNode.removeChild(n);var i=document.createElement("span");i.className="share-count",i.textContent=c.format_count(t),e.appendChild(i)}))},format_count:function(e){return e<1e3?e:e>=1e3&&e<1e4?String(e).substring(0,1)+"K+":"10K+"},bump_sharing_count_stat:function(e){(new Image).src=document.location.protocol+"//pixel.wp.com/g.gif?v=wpcom-no-pv&x_sharing-count-request="+e+"&r="+Math.random()}};window.WPCOMSharing=c}function u(e,t){e.setAttribute("jetpack-share-click-count",t)}function d(e){var t=e.getAttribute("jetpack-share-click-count");return null===t?0:parseInt(t,10)}function l(e,t){var n,o=new XMLHttpRequest;o.open("POST",e,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),o.setRequestHeader("x-requested-with","XMLHttpRequest"),o.send((n=t,(encodeURIComponent("email-share-nonce")+"="+encodeURIComponent(n)).replace(/%20/g,"+")))}function h(){p()}function p(){window.WPCOMSharing&&window.WPCOMSharing.get_counts(),i(document.querySelectorAll(".sharedaddy a"),(function(e){var t=e.getAttribute("href");t&&-1!==t.indexOf("share=")&&-1===t.indexOf("&nb=1")&&e.setAttribute("href",t+"&nb=1")})),i(document.querySelectorAll(".sharedaddy a.sharing-anchor"),(function(e){a.instantiateOrReuse(e)})),void 0!==document.ontouchstart&&document.body.classList.add("jp-sharing-input-touch"),i(document.querySelectorAll(".sharedaddy ul"),(function(e){"true"!==e.getAttribute("data-sharing-events-added")&&(e.setAttribute("data-sharing-events-added","true"),i(e.querySelectorAll("a.share-print"),(function(e){e.addEventListener("click",(function(t){t.preventDefault(),t.stopPropagation();var n=e.getAttribute("href")||"",i=function(){if(-1===n.indexOf("#print")){var e=(new Date).getTime();t=e,o=n,(i=document.createElement("iframe")).setAttribute("style","position:fixed; top:100; left:100; height:1px; width:1px; border:none;"),i.setAttribute("id","printFrame-"+t),i.setAttribute("name",i.getAttribute("id")),i.setAttribute("src",o),i.setAttribute("onload",'frames["printFrame-'+t+'"].focus();frames["printFrame-'+t+'"].print();'),document.body.appendChild(i)}else window.print();var t,o,i},s=o(e,r);if(s){var c=a.getButtonInstanceFromPane(s);c&&(c.close(),i())}else i()}))})),i(e.querySelectorAll("a.share-press-this"),(function(e){e.addEventListener("click",(function(t){t.preventDefault(),t.stopPropagation();var n="";if(window.getSelection?n=window.getSelection():document.getSelection?n=document.getSelection():document.selection&&(n=document.selection.createRange().text),n){var o=e.getAttribute("href");e.setAttribute("href",o+"&sel="+encodeURI(n))}window.open(e.getAttribute("href"),"t","toolbar=0,resizable=1,scrollbars=1,status=1,width=720,height=570")||(document.location.href=e.getAttribute("href"))}))})),i(e.querySelectorAll("a.share-email"),(function(t){u(t,0);var n,o,r=t.getAttribute("data-email-share-nonce"),s=t.getAttribute("data-email-share-track-url");r&&s&&(n=s,o=window.location.protocol+"//"+window.location.hostname+"/",0===String(n).indexOf(o))&&t.addEventListener("click",(function(){var n;u(n=t,d(n)+1),d(t)>2&&function(e,t){var n=t.parentElement;if(n.classList.contains("sd-content")){i(n.querySelectorAll(".share-email-error"),(function(e){e.parentElement.removeChild(e)}));var o=document.createElement("div");o.className="share-email-error";var r=document.createElement("h6");r.className="share-email-error-title",r.innerText=e.getAttribute("data-email-share-error-title"),o.appendChild(r);var s=document.createElement("p");s.className="share-email-error-text",s.innerText=e.getAttribute("data-email-share-error-text"),o.appendChild(s),n.appendChild(o)}}(t,e),l(s,r)}))})))})),i(document.querySelectorAll("li.share-email, li.share-custom a.sharing-anchor"),(function(e){e.classList.add("share-service-visible")}))}"loading"!==document.readyState?h():document.addEventListener("DOMContentLoaded",h),document.body.addEventListener("is.post-load",p)}();;
